tic
pt_u_FileNames = {'WR29_2017-03-10_SingleUnit1001.mat'...
    'WR29_2017-03-10_SingleUnit1002.mat'...
    'WR29_2017-03-10_SingleUnit1003.mat'...
    'WR29_2017-03-10_SingleUnit1004.mat'...
    'WR29_2017-03-10_SingleUnit1005.mat'...
    'WR29_2017-03-13_SingleUnit1001.mat'...
    'WR29_2017-03-13_SingleUnit1002.mat'...
    'WR29_2017-03-13_SingleUnit1003.mat'...
    'WR29_2017-03-13_SingleUnit1004.mat'...
    'WR29_2017-03-13_SingleUnit1005.mat'...
    'WR29_2017-03-14_SingleUnit1001.mat'...
    'WR29_2017-03-14_SingleUnit1002.mat'...
    'WR29_2017-03-14_SingleUnit1003.mat'...
    'WR29_2017-03-14_SingleUnit1004.mat'...
    'WR29_2017-03-15_SingleUnit1001.mat'...
    'WR29_2017-03-15_SingleUnit1002.mat'...
    'WR29_2017-03-15_SingleUnit1003.mat'...
    'WR29_2017-03-15_SingleUnit1004.mat'...
    'WR29_2017-03-15_SingleUnit1005.mat'...
    'WR29_2017-03-15_SingleUnit1006.mat'...
    'WR29_2017-03-16_SingleUnit1001.mat'...
    'WR29_2017-03-16_SingleUnit1002.mat'...
    'WR29_2017-03-17_SingleUnit1001.mat'...
    'WR29_2017-03-17_SingleUnit1002.mat'...
    'WR30_2017-02-26_SingleUnit1001.mat'...
    'WR30_2017-02-26_SingleUnit1002.mat'...
    'WR30_2017-02-27_SingleUnit1001.mat'...
    'WR30_2017-02-27_SingleUnit1002.mat'...
    'WR30_2017-02-28_SingleUnit1001.mat'...
    'WR30_2017-03-01_SingleUnit1001.mat'...
    'WR30_2017-03-01_SingleUnit1002.mat'...
    'WR30_2017-03-01_SingleUnit1003.mat'...
    'WR30_2017-03-02_SingleUnit1001.mat'...
    'WR30_2017-03-02_SingleUnit1002.mat'...
    'WR30_2017-03-06_SingleUnit1001.mat'...
    'WR30_2017-03-08_SingleUnit1001.mat'...
    'WR30_2017-03-08_SingleUnit1002.mat'...
    'WR30_2017-03-08_SingleUnit1003.mat'...
    'WR30_2017-03-08_SingleUnit1004.mat'...
    'WR30_2017-03-09_SingleUnit1001.mat'...
    'WR30_2017-03-09_SingleUnit1002.mat'...
    'WR30_2017-03-10_SingleUnit1001.mat'...
    'WR30_2017-03-10_SingleUnit1002.mat'...
    'WR30_2017-03-10_SingleUnit1003.mat'...
    'WR30_2017-03-10_SingleUnit1004.mat'...
    'WR30_2017-03-20_SingleUnit1001.mat'...
    'WR30_2017-03-20_SingleUnit1002.mat'...
    'WR30_2017-03-20_SingleUnit1003.mat'...
    'WR30_2017-03-20_SingleUnit1004.mat'...
    'WR30_2017-03-20_SingleUnit1005.mat'...
    'WR30_2017-03-21_SingleUnit1001.mat'...
    'WR30_2017-03-21_SingleUnit1002.mat'...
    'WR30_2017-03-21_SingleUnit1003.mat'...
    'WR30_2017-03-22_SingleUnit1001.mat'...
    'WR30_2017-03-22_SingleUnit1002.mat'...
    'WR30_2017-03-23_SingleUnit1001.mat'...
    'WR30_2017-03-23_SingleUnit1002.mat'...
    'WR43_2017-06-21_SingleUnit1001.mat'...
    'WR43_2017-06-21_SingleUnit1002.mat'...
    'WR43_2017-06-21_SingleUnit1003.mat'...
    'WR43_2017-06-21_SingleUnit1004.mat'...
    'WR43_2017-06-22_SingleUnit1001.mat'...
    'WR43_2017-06-22_SingleUnit1002.mat'...
    'WR43_2017-06-22_SingleUnit1003.mat'...
    'WR43_2017-06-22_SingleUnit1004.mat'...
    'WR43_2017-06-23_SingleUnit1001.mat'...
    'WR43_2017-06-23_SingleUnit1002.mat'...
    'WR43_2017-06-23_SingleUnit1003.mat'...
    'WR43_2017-06-23_SingleUnit1004.mat'...
    'WR43_2017-06-24_SingleUnit1001.mat'...
    'WR43_2017-06-24_SingleUnit1002.mat'...
    'WR43_2017-06-24_SingleUnit1003.mat'...
    'WR43_2017-06-25_SingleUnit1001.mat'...
    'WR43_2017-06-25_SingleUnit1002.mat'...
    'WR43_2017-06-25_SingleUnit1003.mat'...
    'WR43_2017-06-25_SingleUnit1004.mat'...
    'WR43_2017-06-25_SingleUnit1005.mat'...
    'WR43_2017-06-27_SingleUnit1001.mat'...
    'WR43_2017-06-27_SingleUnit1002.mat'...
    'WR43_2017-06-27_SingleUnit1003.mat'... 
    'WR43_2017-06-27_SingleUnit1004.mat'};

% Pre-allocation of matrix
L = zeros(1170888, 44);
for file = 1:length(pt_u_FileNames)
    fprintf('Loaded ' + string(pt_u_FileNames(file)) + '\n')
    load(string(pt_u_FileNames(file)))
    % Access each waveform of the unit
    for x = 1:size(unit.waveform,1)
        %fill with features
        maxIdx = wvfrmExtraction(unit.waveform(x,:));
        numWvfrm = floor(size(unit.waveform,2) / 32);
        inputWvfrm = unit.waveform(x,((32*(maxIdx-1) + 1):(maxIdx * 32)));
        inputST = unit.spike_times;
        L(x,1) = 1;
        L(x,2) = fullAmplitude(inputWvfrm);
        L(x,3) = negAmplitude(inputWvfrm);
        L(x,4) = posAmplitude(inputWvfrm);
        L(x,5) = widthTP(inputWvfrm);
        L(x,6) = widthPT(inputWvfrm);
        isiArr = interspike(inputST);
        L(x, 7) = isiArr(x);
        regArr = regularity(isiArr);
        L(x,8) = regArr(x);
        eT_len = length(inputST);
        L(x,9) = burstiness(isiArr, eT_len);
        if numWvfrm == 4 || numWvfrm == 5
            L(x,10) = unit.channel(x) + (maxIdx - 3);
        elseif numWvfrm == 6 || numWvfrm == 7
            L(x,10) = unit.channel(x) + (maxIdx - 4);
        else
            L(x,10) = unit.channel(x) + (maxIdx - 5);     
        end
        L(x,11) = unit.shank;
        L(x,12) = unit.ix(x,1);
        for ind = 13:44
            L(x, ind) = inputWvfrm(ind - 12); 
        end
    end
fprintf('Completed ' + string(pt_u_FileNames(file)) + '\n')
end
csvwrite('U', U);
toc

% Extract largest waveform of 5-7 waveforms
function idx = wvfrmExtraction(w)
    amplitude = zeros(8, 2);
    numWvfrm = floor(size(w,2) / 32);
    maxIdx = 0;
    maxAmp = -1;
    for wvfrm = 1:numWvfrm
        amplitude(wvfrm,1) = fullAmplitude(w((32*(wvfrm-1) + 1):(wvfrm * 32)));
        amplitude(wvfrm,2) = wvfrm;
        if amplitude(wvfrm,1) > maxAmp
            maxAmp = amplitude(wvfrm,1);
            maxIdx = amplitude(wvfrm,2);
        end
    end
    idx = maxIdx; 
end

% Full amplitude - Maximum - minimum
function fA = fullAmplitude(w)
    minVal = min(w);
    maxVal = max(w);
    fA = maxVal - minVal;
end

% Negative amplitude - 0 - minimum
function nA = negAmplitude(w)
    minVal = min(w);
    nA = 0 - minVal;
end

% Positive amplitude - Max - 0
function pA = posAmplitude(w)
    maxVal = max(w);
    pA = maxVal;
end

% Recovery time - Distance from trough to first peak after trough
function wTP = widthTP(w)
    minVal = min(w);
    minInd = find(w == minVal);
    if size(minInd, 2) > 1
        minInd = minInd(1);
    end
    wNew = w(minInd:32);
    maxVal = max(wNew);
    maxInd = find(w == maxVal);
    if size(maxInd, 2) > 1
        maxInd = maxInd(1);
    end
    wTP = maxInd - minInd;
end

% Spike time - Distance from initial peak to trough
function wPT = widthPT(w)
    minVal = min(w);
    minInd = find(w == minVal);
    if size(minInd, 2) > 1
        minInd = minInd(1);
    end
    wNew = w(1:minInd);
    maxVal = max(wNew);
    maxInd = find(w == maxVal);
    if size(maxInd, 2) > 1
        maxInd = maxInd(1);
    end
    wPT = minInd - maxInd;
end

% Interspike interval - Time between consecutive spikes
function isi = interspike(eT)
    %look at diff between spike times; ISI array same size
    %as waveforms
    diffET = zeros(1,length(eT));
    for time = 1:length(eT)-1
        %for when time loops to 0 because of new trial
        if eT(time+1) < eT(time)
            diffET(time) = mean(diffET(1:time-1));
        else
            diffET(time) = eT(time + 1) - eT(time);
        end
    end
    diffET(length(eT)) = mean(diffET);
    isi = diffET; 
end

% Regularity - variance of the ratio between consecutive ISIs
function reg = regularity(isiArray)
    ratios = zeros(1,length(isiArray));
    for isiN = 1:length(isiArray)-1
        ratios(isiN) = (((isiArray(isiN)) / (isiArray(isiN+1) + isiArray(isiN))) - 0.5)^2;
    end
    ratios(length(isiArray)) = mean(ratios);
    reg = ratios;
end
    
% Burstiness - the number of ISIs that are less than a tenth of the mean,
%   implying a burst
function b = burstiness(isiArray2, eT_len)
    %fraction of ISIs less than a tenth of the average ISI
    count = 0;
    meanISI = mean(isiArray2(1:eT_len));
    for indISI = 1:length(isiArray2(1:eT_len))
        if (isiArray2(indISI) ~= 0) && (isiArray2(indISI) < (0.1 * meanISI))
            count = count + 1;
        end
    end
    b = count;
end
